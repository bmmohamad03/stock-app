<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sortie de Stock ‚Äì CHIMIO TECHNIC</title>
  <link rel="icon" href="icon-192.png" type="image/png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-white min-h-screen flex items-center justify-center">
  <div class="bg-white shadow-xl rounded-xl p-6 w-full max-w-md">
    <div class="text-center mb-4">
      <img src="chimio_technic_logo.png" alt="Logo Chimio Technic" class="mx-auto w-32">
    </div>
    <h2 class="text-xl font-bold text-gray-800 text-center mb-4">Sortie de Stock</h2>

    <div id="spinner" class="hidden text-center text-sm text-gray-500 mb-2">‚è≥ Envoi en cours...</div>
    <div id="syncPending" class="hidden text-center text-orange-600 text-sm mt-2">üîÅ Sorties √† synchroniser...</div>

    <form id="formSortie" class="space-y-4">
      <div>
        <label for="codeProduitInput" class="block text-sm font-semibold text-gray-700">üîç Code Produit</label>
        <input list="produitList" id="codeProduitInput" name="codeProduit" required class="w-full border rounded-md p-2" placeholder="Rechercher ou taper un code..." />
        <datalist id="produitList"></datalist>
      </div>

      <div>
        <label for="quantite" class="block text-sm font-semibold text-gray-700"><i class="fas fa-sort-numeric-up"></i> Quantit√©</label>
        <input type="number" id="quantite" min="1" required class="w-full border rounded-md p-2" />
        <div id="errorQuantite" class="text-red-500 text-sm"></div>
      </div>

      <div>
        <label for="operateur" class="block text-sm font-semibold text-gray-700"><i class="fas fa-user"></i> Nom de l‚Äôop√©rateur</label>
        <input type="text" id="operateur" required pattern="^[a-zA-Z√Ä-√ø\s\-]+$" class="w-full border rounded-md p-2" />
        <div id="errorOperateur" class="text-red-500 text-sm"></div>
      </div>

      <div>
        <label for="motif" class="block text-sm font-semibold text-gray-700"><i class="fas fa-edit"></i> Motif</label>
        <select id="motif" required class="w-full border rounded-md p-2">
          <option value="Vente" selected>Vente</option>
          <option value="Casse">Casse</option>
          <option value="Test">Test</option>
          <option value="Autre">Autre</option>
        </select>
      </div>

      <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white font-semibold py-2 rounded hover:bg-blue-700">Valider la sortie</button>
    </form>

    <div id="confirmationMsg" class="mt-4 text-green-600 font-medium text-center"></div>
    <div id="lastEntry" class="mt-4 text-sm text-gray-700"></div>
    <div id="historique" class="mt-4 text-sm text-gray-700"></div>
  </div>

  <script>
    const produits = ["J005","J001","J002","J003","PR001","PR002","PR003","L006","L0061","L0062","N012","N013","N014","NPC001","NPP002","NPG003","NPM004","N006","N009","M001","M002","M004","REX005","M007"];
    const datalist = document.getElementById("produitList");
    const codeInput = document.getElementById("codeProduitInput");
    produits.forEach(code => {
      const option = document.createElement("option");
      option.value = code;
      datalist.appendChild(option);
    });

    const form = document.getElementById("formSortie");
    const spinner = document.getElementById("spinner");
    const syncPending = document.getElementById("syncPending");
    const confirmationMsg = document.getElementById("confirmationMsg");
    const lastEntry = document.getElementById("lastEntry");
    const historique = document.getElementById("historique");
    const motifSelect = document.getElementById("motif");
    const operateurInput = document.getElementById("operateur");

    operateurInput.value = localStorage.getItem("operateur") || "";
    operateurInput.addEventListener("input", () => {
      localStorage.setItem("operateur", operateurInput.value);
    });

    function afficherHistorique(data) {
      if (!data || data.length === 0) return;
      historique.innerHTML = `<h3 class="font-semibold mb-1">üóÇÔ∏è 5 derniers mouvements :</h3>`;
      const table = document.createElement("table");
      table.className = "w-full text-sm border-collapse";
      table.innerHTML = `
        <thead><tr class="bg-gray-100"><th>Produit</th><th>Qt√©</th><th>Op√©rateur</th><th>Motif</th><th>Heure</th></tr></thead>
        <tbody>
          ${data.map(m => `<tr><td>${m.codeProduit}</td><td>${m.quantite}</td><td>${m.operateur}</td><td>${m.motif}</td><td>${m.date}</td></tr>`).join("")}
        </tbody>
      `;
      historique.appendChild(table);
    }

    function enregistrerHistoriqueLocally(mouvement) {
      let historiqueStock = JSON.parse(localStorage.getItem("historiqueStock") || "[]");
      historiqueStock.unshift(mouvement);
      historiqueStock = historiqueStock.slice(0, 5);
      localStorage.setItem("historiqueStock", JSON.stringify(historiqueStock));
      afficherHistorique(historiqueStock);
    }

    function verifierSyncPending() {
      const sorties = JSON.parse(localStorage.getItem("sortiesEnAttente") || "[]");
      if (sorties.length > 0) {
        syncPending.classList.remove("hidden");
      } else {
        syncPending.classList.add("hidden");
      }
    }

    function sauvegarderLocal(data) {
      const sortiesEnAttente = JSON.parse(localStorage.getItem("sortiesEnAttente") || "[]");
      sortiesEnAttente.push(data);
      localStorage.setItem("sortiesEnAttente", JSON.stringify(sortiesEnAttente));
      verifierSyncPending();
    }

    function synchroniserSorties() {
      const sorties = JSON.parse(localStorage.getItem("sortiesEnAttente") || "[]");
      if (sorties.length === 0) return;
      const sortie = sorties[0];
      fetch(https://api-stock-sortie.onrender.com/enregistrer_sortie, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(sortie)
      })
      .then(res => {
        if (!res.ok) throw new Error();
        sorties.shift();
        localStorage.setItem("sortiesEnAttente", JSON.stringify(sorties));
        verifierSyncPending();
        enregistrerHistoriqueLocally(sortie);
        synchroniserSorties();
      })
      .catch(() => console.log("‚è≥ En attente de r√©seau pour envoyer la sortie"));
    }

    form.addEventListener("submit", function(event) {
      event.preventDefault();
      spinner.classList.remove("hidden");
      const codeProduit = codeInput.value.trim();
      const quantite = parseInt(document.getElementById("quantite").value);
      const operateur = operateurInput.value.trim();
      const motif = motifSelect.value;
      const dateLocale = new Date().toLocaleString();
      const data = {
        codeProduit,
        quantite,
        operateur,
        motif,
        dateHeure: new Date().toISOString(),
        date: dateLocale
      };

   fetch("https://api-stock-sortie.onrender.com/enregistrer_sortie", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(data)
})

      .then(res => {
        if (!res.ok) throw new Error();
        confirmationMsg.textContent = "‚úÖ Sortie enregistr√©e le " + dateLocale;
        lastEntry.innerHTML = `<strong>Dernier mouvement :</strong><br>Produit : ${codeProduit}<br>Quantit√© : ${quantite}<br>Op√©rateur : ${operateur}<br>Motif : ${motif}<br>Heure : ${dateLocale}`;
        enregistrerHistoriqueLocally(data);
        form.reset();
        motifSelect.value = "Vente";
        operateurInput.value = operateur;
      })
      .catch(() => {
        sauvegarderLocal(data);
        alert("üì¥ Pas de r√©seau. Mouvement sauvegard√© localement.");
      })
      .finally(() => {
        spinner.classList.add("hidden");
      });
    });

    setInterval(() => {
      if (navigator.onLine) {
        synchroniserSorties();
      }
    }, 10000);

    window.addEventListener("load", () => {
      verifierSyncPending();
      afficherHistorique(JSON.parse(localStorage.getItem("historiqueStock") || "[]"));
    });
  </script>
</body>
</html>
